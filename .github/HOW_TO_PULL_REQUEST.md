# How To Pull Request

- PR 先: `master` ブランチ

PR 先は `master` ブランチにお願いします。

typo, ドキュメント改善、リファクタ、不具合修正など、どんな PR（[プルリク](https://docs.github.com/ja/github/getting-started-with-github/quickstart/github-glossary#pull-request)）でも歓迎です。PR に馴染みがない方も、PR の練習がてら遠慮なく試してみてください。何か失敗しても、みんなで直して行きましょう。

## PR 作業を始める前に

PR の作業に入る前に、過去の PR や Issue や Discussion を検索・確認してください。

と言うのも「途中まで実装するも諸事情により諦めた過去の PR」があるかもしれないからです。引き継げるなら（流用できるなら）それに越したことはありません。

もしくは「同じ内容の提案や実装をするも却下されたもの」もあるかもしれません。せっかく PR しても同じ理由で却下されないためにも、確認をお願いします。

## 自動テストについて

このリポジトリでは、`PR` もしくは `PR` されたブランチに `push` があると自動的に基本テストが走ります。

基本テストには `linter`（構文・文法チェック）、静的解析、ユニット・テストが含まれます。

これらのテストをパスしないと、PR されてもレビューおよびマージはされません。

- 詳しくは [HOW_TO_RUN_TESTS.md](./HOW_TO_RUN_TESTS.md) をご覧ください。

## レビューについて

[レビュー](https://docs.github.com/ja/github/getting-started-with-github/quickstart/github-glossary#review)とは、コントリビュータが「PR 内容」の確認と「気になる点」をコメントすることを言います。

- コントリビュートについて: [HOW_TO_CONTRIBURE.md](./HOW_TO_CONTRIBUTE.md)

つまり、自分が作成・修正したドキュメントやスクリプトを「手離れさせる」「独り立ちさせる」ための受け入れの儀式（[マージ](https://docs.github.com/ja/github/getting-started-with-github/quickstart/github-glossary#merge)前の確認）でもあります。

PR 時にレビュー数が多いほど、また修正をするほど、その後のメンテナンス性と均質性が増します。

ここで言う均質性とは、リポジトリ内の他のドキュメントや、スクリプトが持つ方言・習慣的なものとの「馴染みやすさ」を言います。

レビューをクチうるさく感じるかもしれませんが、マージされた直後からコントリビュータ全員がその後の面倒をみやすくなるためなので、他意はありません。

また、レビューを経ても「マージ後に気付いた」ことの方が多いため、別途「追い PR」されて成長して行きます。そのため、**一度マージされたものは、自分の意図しない方向に進む可能性がある**ことをご承知おきください。

## マージについて

レビュアーの `Approved` が付くと、リポジトリ責任者（不在の場合はメンテナ）の判断により PR が `main` ブランチにマージ（`squash merge`）されます。 （`squash` に関しては下部にある「理想的な PR の流れ」をご覧ください）

## PR 時の注意点

基本的に **`Reviewer`（レビュアー。レビューする人）の割り当ては、レビュイー（PR する側。レビューされる側）からはしないでください**。

基本は、レビュアー本人かメンテナ（リポジトリの維持を担当する[コラボレータ](https://docs.github.com/ja/github/getting-started-with-github/quickstart/github-glossary#collaborator)）によって割り当てられます。

PR のコメントによりレビュー依頼に気づいたコントリビュータが「（お。いま余裕あるからチェックしよっかなー）」とか、PR 内容をみて「（あ。いささか気になる点があるー）」とか「（typo めっけ！）」と思ったコントリビュータが `Reviewers` に自身を割り当てます。

**レビューの目は、多ければ多いほど良い**ので、1 人のコントリビュータが、すべての問題のチェックの責任を追うものではありませんし、複数人がレビューすることもあります

また、レビューの立候補者が出てこなさそうな場合や、内容によって「特定のコントリビュータの目を通させた方がいいかもしれない」とメンテナが判断した場合は、`ping` 的にレビュアーを `Reviewers` に割り当てることもあります。

もちろん、特定のコントリビュータにお願いしたい場合を除きます。ご指名というやつです。その場合はコメントに[メンション](https://docs.github.com/ja/github/getting-started-with-github/quickstart/github-glossary#mention)をお願いします。（他のテーブルが忙しくてレビューに来れないかもしれませんが）

- コントリビュータ
  - https://github.com/Qithub-BOT/QiiCipher/graphs/contributors
- メンテナ
  - @yoshi389111
  - @KEINOS
- リポジトリ責任者
  - @KEINOS

## Draft PR のススメ

このリポジトリでは Draft PR を用いた PR を推奨しています。

- [Draft Pull Requestをリリースしました](https://github.blog/jp/2019-02-19-introducing-draft-pull-requests/) @ GitHub 公式ブログ

### Draft PR について

Draft PR とは、何かの作業を始める前に `Draft` で PR を上げてから作業を開始する方法です。

一応の作業が終わり、一連の必須テストもパスしたら、**`Draft` を外してレビュー依頼をコメントするとレビューが開始されます**。

サクッとできない（時間のかかりそうな）類いの PR を進める場合は、Draft PR をオススメします。もちろん、小さな PR や、PR に慣れた方は、この限りではありません。

### 従来の PR 方法と Draft PR の違い

従来の（最も一般的な）PR 方法である「成果物のみを PR する」方法と比べ、Draft PR によるメリットは以下の通りです。

1. 別の人が同じ内容の作業を進めていないか事前に確認できる。
    - これまでは Fork されたリポジトリ先を 1 つ 1 つ覗きに行って、作業ブランチがないかなどを確認しないといけませんでした。つまり、実質的に PR 前の作業内容を知ることが難しかったのです。
2. 作業ブランチにコミットを `push` すると、PR 先の Upstream（本家 QiiCipher）のリポジトリ上で必須テストが勝手に走るので、本番 PR 前に最低限のテストができる。
    - これは、Fork した自分のリポジトリでテストを走らせなくてもいいので、自分の [GitHub の無料使用時間](https://docs.github.com/ja/actions/reference/usage-limits-billing-and-administration#usage-limits)のクォーター（割り当て）を消費しません。
3. 作業内容が見えることで、他の人が次のステップ（もしくは作業）の準備を進めやすい。
4. 作業経過が見えることで、コントリビュータがレビューの情報を予め知ることができる。
    - 基本的にコントリビュータは `Draft` が外れるまで口を出しません。かといって `Draft` 作業中も必ずチェックしているというわけでもありません。しかし、誰かが「（この PR のレビューを担当しようかなぁ〜）」と思った時に覗けるということです。
5. 作業を途中で降りることが気軽にできる。
    - PR ゆうても `Draft` です。力尽きたり、時間がなかったり、作業が苦しくなったり、思っていたより作業量が多かったなど、**諸事情ある場合は、遠慮なく Draft PR を `close` してください**。気に病む必要はありません。
6. 作業を引き継ぐことができる。
    - `Draft` PR を行うことにより作業内容が残ることになります。これは、他のコントリビュータの参考情報となり、流用可能な作業内容を引き継げるということでもあります。おそらく、これが 1 番のメリットかも知れません。

## 理想的な PR の流れ

[PR (Pull Request)](https://docs.github.com/ja/desktop/contributing-and-collaborating-using-github-desktop/working-with-your-remote-repository-on-github-or-github-enterprise/creating-an-issue-or-pull-request#creating-a-pull-request) に慣れている方は、この限りではありませんが、理想的な PR のフローは以下の通りです。

1. 準備（リポジトリの Fork と `clone`）
    1. QiiCipher の本家リポジトリを自分の GitHub アカウントに [Fork](https://docs.github.com/ja/github/getting-started-with-github/quickstart/fork-a-repo) する。
        - Fork とは、GitHub 内で他者のリポジトリを、自分のアカウントにリポジトリを `clone` する [GitHub 用語](https://docs.github.com/ja/github/getting-started-with-github/quickstart/github-glossary#fork)です。`Fork` したリポジトリから見ると本家のリポジトリが `Origin`（起源）となります。
    2. Fork した GitHub リポジトリをローカル（自分の PC）に `clone` する。
        - これにより GitHub 上の `Fork` したリポジトリが、ローカルから見たときの `Origin`（起源）となります。
        - 同様に、ローカルから見たときの `Origin` の `Origin` は本家のリポジトリになり、 `Upstream`（上流）と呼ばれます。
    3. ローカルの `master` ブランチから作業用のブランチを作成する。
    4. 作業に使う何かしらのファイルを作成し、コミットと作業用ブランチを GitHub の Fork に `push` する。
        - 一般的に「空のファイル」「ハリボテの関数」「実装予定のテスト」などです。
        - この「未実装」のコミットをするのは、以下の 2 つの理由からです。
            1. 何かしらコミットがないと PR はできないから
            2. 「ここらへんをいじるよ」というアピール
        - 「実装予定のテスト」とは、実装により期待する結果をテストするものです。例えば、新しい「俺さま関数」を作る場合は「その関数が出力すべき戻り値」をテストに書いておく、ということです。[現在のテスト](../tests)を見るのも参考になると思います。「（あ、こんなものなの？）」と思うと思います。テストについての詳細や書き方は「HOW_TO_CREATE_TESTS.md」をご覧ください。
2. 作業の通知
    1. 作業ブランチを Upstream（QiiCipher の本家リポジトリ）の `master` に `Draft` で PR を送る。
        - 作業を始める前に、ほとんど手を入れていない状態で PR してしまいましょう。大事なのは `Draft` で PR することです。PR 時に GitHub 上で `Draft` を設定できます。<br>![](https://user-images.githubusercontent.com/11840938/120753083-99484e00-c545-11eb-836a-afafa9bee29a.png)
        - PR のタイトルやコメントは、「どのような実装か」「後日検索しても引っかかりやすい」「わかりやすい情報」を念頭に書いてください。たった 1 つの不具合修正、たった 1 つの機能実装など、PR の内容の粒（変更箇所）が、小さければ小さいほど助かります。
3. 実作業／実装
    1. 作業ブランチに変更とコミットを続け、適度なタイミングで結果を Fork したリポジトリに `push` する。
        - この作業ブランチは（Draft で）PR 済みなので、PR にも反映される。
        - 「細々としたコミットになってしまう」と、コミット履歴が汚れるのが心配になるかもしれません。大丈夫です。**QiiCipher では [`squash`](https://docs.github.com/ja/github/getting-started-with-github/quickstart/github-glossary#squash) して（コミットを 1 つにまとめて）から `master` へマージする運用**になっています。そのため、試行錯誤のコミットであっても問題ありません。思う存分試行錯誤や、細かいコミットをしてください。
    2. リポジトリに `push` されると `Draft` で PR されているため Upstream 上で必須テストが走る。
        - 必須テストは： [lint](https://ja.wikipedia.org/wiki/Lint#%E3%80%8Clint%E3%80%8D%E3%81%AE%E6%B4%BE%E7%94%9F%E7%94%A8%E6%B3%95)（文法・構文チェック）、スクリプトの[静的解析](https://ja.wikipedia.org/wiki/%E9%9D%99%E7%9A%84%E3%82%B3%E3%83%BC%E3%83%89%E8%A7%A3%E6%9E%90)、[ユニット・テスト](https://ja.wikipedia.org/wiki/%E5%8D%98%E4%BD%93%E3%83%86%E3%82%B9%E3%83%88)です。
    3. テストがパスするまで実装を続けます。（実作業／実装の 1 に戻る）
        - 「（やっべ。思ってたより作業量多いや）」「（やっべ。リアルが忙しくなってきた）」「（やっべ。ぶっちゃけモチベ落ちてる）」といった場合は、PR のタイトルや内容を書き換えて、出来ているところまで作業範囲を狭めて、次の「レビュー依頼」へ進んでください。<br>もしくは、**遠慮なく PR を `close` してください**。`Draft` なんですから。やる気が帰ってきたら「再 Draft PR」をして続ければいいだけです。もしかすると、ハマっていた箇所に気づいた他の人が、そこをサクッと実装してくれているかもしれません。（しないかもしれません）
4. レビュー依頼（`Draft` を外す = 本番 PR 化）
    1. 実装が終わり、テストがパスした場合は、`Draft` を外す。
    2. PR 画面でレビュー依頼をコメントする。
        - 依頼コメントは過去の PR を参考にしてください。
    2. `Reviewers` が割り当てられると、レビューが始まる。
        - `Reviewers` の割り当ては、基本的にレビュー依頼に気づいたコントリビュータが自分自身で `Reviewers` に割り当て（立候補し）ます。
        - 数日経っても、一向に `Reviewers` に立候補してくれる人が現れない場合は、以下の画像（or もっと面白い画像）を使ってください。メンテナが割り当てを行い、コントリビュータに打診します。
            - ![](https://user-images.githubusercontent.com/11840938/120618564-292ebf00-c496-11eb-8c1c-e4d6e515362b.jpeg)
        - レビュアー（レビューする人）は、PR 内の変更されたファイルや箇所を確認していき `Viewed` フラグを立てて行きます。途中、気づいたり、気になった点があると適宜コメントを付けて行きます。
        - テストや仕様やセキュリティに関することでない限り、コメントは「必ず修正しろ」というものではありません。しかしコントリビュータが「いま見てもわからないこと」は、「未来のコントリビュータも、わからないかも」ということだったり、「動いちゃうけど、いま気づいたミスは、未来でもミス」ということを明確にするものです。つまりマージ後に未来のコントリビュータに出来るだけ負荷をかけないためにレビューがあります。
    3. レビュアーからの指摘を受けた場合は、それらを修正して追いコミットを `push` してゆく。
    4. 全ての指摘の修正もしくは変更箇所に `Viewed` が付くとレビュアーは PR を `Approve`（承認）し、コメント欄に `LGTM` (`Looks Good To Me`) を付ける。
5. マージ作業
    1. リポジトリ管理者が `LGTM` もしくは `Approved` を確認すると `master` ブランチへのマージ作業をはじめる。
        - テストがパスしており、複数レビュアーからの `Approve` が付いた場合は、自動的にマージされます。（現在は未設定）
    1. マージが完了すると PR 時の作業ブランチは Upstream（本家）から自動削除される。
        - Fork 先の自分のリポジトリおよびローカルにある作業ブランチは残りますので、自分のリポジトリの自動削除設定をするか手動で削除してください。
        - 【注意】この時、ローカルもしくは `Fork` したリポジトリの `master` ブランチに作業ブランチはマージしないでください。次のステップで変更をマージします。
6. 本家に追随
    1. 以下のどちらかで、本家（`Upstream`）の変更に追随する。
        - ローカルの `master` ブランチに、`Upstream` の `master` ブランチの変更（先にマージされた PR の変更）をマージして、Fork に `push` する。
        - GitHub 上の Fork リポジトリの画面で `Upstream` の変更を `master` にマージした場合は `pull origin` でローカルの `master` を更新（本家に追随）します。
